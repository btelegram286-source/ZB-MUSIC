name: Deploy to Render

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Render
      run: |
        curl -X POST \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "serviceId": "srv-d2t1ktvfte5s739phv5g",
            "clearCache": "do_not_clear"
          }' \
          https://api.render.com/v1/services/srv-d2t1ktvfte5s739phv5g/deploys
          
    - name: Update Environment Variables
      run: |
        # BOT_TOKEN güncelleme
        curl -X PUT \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "envVar": {
              "key": "BOT_TOKEN",
              "value": "${{ secrets.BOT_TOKEN }}"
            }
          }' \
          https://api.render.com/v1/services/srv-d2t1ktvfte5s739phv5g/env-vars/BOT_TOKEN

        # ADMIN_CHAT_ID güncelleme
        curl -X PUT \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "envVar": {
              "key": "ADMIN_CHAT_ID",
              "value": "${{ secrets.ADMIN_CHAT_ID }}"
            }
          }' \
          https://api.render.com/v1/services/srv-d2t1ktvfte5s739phv5g/env-vars/ADMIN_CHAT_ID

        # BASE_URL güncelleme
        curl -X PUT \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "envVar": {
              "key": "BASE_URL",
              "value": "${{ secrets.BASE_URL }}"
            }
          }' \
          https://api.render.com/v1/services/srv-d2t1ktvfte5s739phv5g/env-vars/BASE_URL

        # DASHBOARD_PASSWORD güncelleme
        curl -X PUT \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "envVar": {
              "key": "DASHBOARD_PASSWORD",
              "value": "${{ secrets.DASHBOARD_PASSWORD }}"
            }
          }' \
          https://api.render.com/v1/services/srv-d2t1ktvfte5s739phv5g/env-vars/DASHBOARD_PASSWORD

        # DASHBOARD_PASSWORD_HASH_SHA256 güncelleme
        curl -X PUT \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "envVar": {
              "key": "DASHBOARD_PASSWORD_HASH_SHA256",
              "value": "${{ secrets.DASHBOARD_PASSWORD_HASH_SHA256 }}"
            }
          }' \
          https://api.render.com/v1/services/srv-d2t1ktvfte5s739phv5g/env-vars/DASHBOARD_PASSWORD_HASH_SHA256

        # OPENAI_KEY güncelleme
        curl -X PUT \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "envVar": {
              "key": "OPENAI_KEY",
              "value": "${{ secrets.OPENAI_KEY }}"
            }
          }' \
          https://api.render.com/v1/services/srv-d2t1ktvfte5s739phv5g/env-vars/OPENAI_KEY

        # WEBHOOK_SECRET güncelleme
        curl -X PUT \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "envVar": {
              "key": "WEBHOOK_SECRET",
              "value": "${{ secrets.WEBHOOK_SECRET }}"
            }
          }' \
          https://api.render.com/v1/services/srv-d2t1ktvfte5s739phv5g/env-vars/WEBHOOK_SECRET

        # WEB_SECRET_KEY güncelleme
        curl -X PUT \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "envVar": {
              "key": "WEB_SECRET_KEY",
              "value": "${{ secrets.WEB_SECRET_KEY }}"
            }
          }' \
          https://api.render.com/v1/services/srv-d2t1ktvfte5s739phv5g/env-vars/WEB_SECRET_KEY

        # WEB_PORT güncelleme
        curl -X PUT \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "envVar": {
              "key": "WEB_PORT",
              "value": "${{ secrets.WEB_PORT }}"
            }
          }' \
          https://api.render.com/v1/services/srv-d2t1ktvfte5s739phv5g/env-vars/WEB_PORT

        # YT_COOKIES güncelleme (opsiyonel)
        curl -X PUT \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "envVar": {
              "key": "YT_COOKIES",
              "value": "${{ secrets.YT_COOKIES }}"
            }
          }' \
          https://api.render.com/v1/services/srv-d2t1ktvfte5s739phv5g/env-vars/YT_COOKIES
